# Document Summaries in Sidebar - Implementation

## Problem

Documents were appearing in the left sidebar after upload, but summaries were not being displayed. Users couldn't see what their documents contained without clicking on them or querying the chat.

## Solution

Updated the `DocumentsSidebar` component to:
1. Fetch summary data from `analysis_results` table
2. Display summaries in the sidebar UI
3. Show vision summaries for images or OCR text previews for documents

## Changes Made

### 1. Updated Document Interface

**File:** `src/components/DocumentsSidebar.tsx`

Added summary fields to the `Document` interface:
```typescript
interface Document {
  // ... existing fields
  summary?: string | null; // vision_summary or ocr_text preview
  visionSummary?: string | null;
  ocrText?: string | null;
}
```

### 2. Enhanced Database Query

Updated the Supabase query to join with `analysis_results` table:

**Before:**
```typescript
.select("id, file_name, file_type, file_size, status, metadata, created_at, updated_at, analysis_target")
```

**After:**
```typescript
.select(`
  id, 
  file_name, 
  file_type, 
  file_size, 
  status, 
  metadata, 
  created_at, 
  updated_at, 
  analysis_target,
  analysis_results (
    vision_summary,
    ocr_text
  )
`)
```

### 3. Summary Extraction Logic

Added logic to extract and prioritize summaries:
- **Priority 1:** `vision_summary` (for images analyzed with vision models)
- **Priority 2:** First 200 characters of `ocr_text` (for text-extracted documents)
- **Fallback:** `null` if neither is available

### 4. UI Display

Added summary display in the document card:
```typescript
{doc.summary && (
  <p className="text-[10px] text-muted-foreground mt-1.5 line-clamp-2" title={doc.summary}>
    {doc.summary}
  </p>
)}
```

## How It Works

### For Images
1. Image uploaded → `vision-worker` processes it
2. Vision analysis generates `vision_summary` in `analysis_results`
3. Sidebar displays the vision summary

### For Documents (PDFs, etc.)
1. Document uploaded → `textract-worker` processes it
2. Text extraction stores `ocr_text` in `analysis_results`
3. Sidebar displays first 200 characters as preview

### Display Format

Each document in the sidebar now shows:
- **File name** (bold)
- **Status and stage** (e.g., "completed • indexed")
- **File size**
- **Summary** (if available) - truncated to 2 lines with ellipsis

## Database Schema

The relationship between tables:
```
processing_jobs (id)
    ↓
analysis_results (job_id) → foreign key
    ├── vision_summary (text) - for images
    └── ocr_text (text) - for documents
```

## Testing

To verify summaries are working:

1. **Upload an image:**
   - Upload a photo or screenshot
   - Wait for processing to complete
   - Check sidebar - should show vision summary

2. **Upload a PDF/document:**
   - Upload a PDF or text document
   - Wait for processing to complete
   - Check sidebar - should show OCR text preview

3. **Check console:**
   - Look for `[DocumentsSidebar] ✅ Successfully loaded X document(s)`
   - Verify no errors about `analysis_results`

## Future Enhancements

Potential improvements:
- Generate AI summaries for long documents (not just OCR preview)
- Allow expanding/collapsing full summaries
- Show summary generation status
- Add "Regenerate summary" button
- Support for multiple summary types (executive, detailed, etc.)

## Notes

- Summaries only appear after processing is complete
- Vision summaries are generated by vision-worker (GPT-4 Vision, Gemini, etc.)
- OCR text is extracted by textract-worker (AWS Textract)
- The query uses Supabase's automatic relationship detection (foreign key)

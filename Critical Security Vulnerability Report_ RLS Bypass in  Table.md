# Critical Security Vulnerability Report: RLS Bypass in `analysis_results` Table

**To:** Development Team
**From:** Autonomous Agent (Manus)
**Date:** Dec 07, 2025
**Subject:** Immediate action required to fix Row Level Security (RLS) misconfiguration.

---

### Summary of Vulnerability

During the analysis of the document pipeline bug bounty challenge, a critical security vulnerability was discovered in the Supabase database configuration for the `analysis_results` table.

**Unauthenticated users (Guest users) are currently able to query and retrieve the full contents of the `analysis_results` table, including sensitive document summaries and OCR text, bypassing intended Row Level Security (RLS) controls.**

This vulnerability allows for unauthorized information disclosure of all processed documents, regardless of the user who uploaded them.

### Recommended Fix

The RLS policy on the `analysis_results` table must be immediately reviewed and corrected.

**Action Required:**

1.  **Verify RLS is Enabled:** Ensure RLS is enabled for the `analysis_results` table.
2.  **Correct `SELECT` Policy:** The `SELECT` policy for the `analysis_results` table must be restricted to ensure that:
    *   It only grants access to **authenticated users** (`auth.uid() IS NOT NULL`).
    *   The user can only view results for jobs where the associated `processing_jobs.user_id` matches their own user ID (`auth.uid()`).
    *   A separate policy may be needed to allow authenticated users to view results for jobs where `processing_jobs.user_id` is `NULL` (for public or system-uploaded documents), provided this is the intended behavior.

**Example SQL for a secure RLS policy (to be verified against the schema):**

```sql
-- Policy to allow authenticated users to view their own analysis results
CREATE POLICY "Users can view their own analysis results"
ON analysis_results FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1
    FROM processing_jobs
    WHERE processing_jobs.id = analysis_results.job_id
      AND processing_jobs.user_id = auth.uid()
  )
);

-- Policy to allow viewing of results for jobs with NULL user_id (if intended)
CREATE POLICY "Authenticated users can view NULL user_id results"
ON analysis_results FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1
    FROM processing_jobs
    WHERE processing_jobs.id = analysis_results.job_id
      AND processing_jobs.user_id IS NULL
  )
);
```

### Additional Note on Issue 1 Fix

The bug bounty document correctly identified that **Issue 1: Documents Not Appearing in Left Panel** was partially due to documents with a `NULL` user ID not being queried. I have applied the client-side fix to `src/components/DocumentsSidebar.tsx` to include these documents in the query:

```typescript
// Before (in DocumentsSidebar.tsx)
.eq("user_id", userId)

// After (in DocumentsSidebar.tsx)
.or(`user_id.eq.${userId},user_id.is.null`)
```

This client-side fix is now in the local repository clone. The RLS fix above is the more critical security issue that needs server-side attention.
